<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Thanh To√°n</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f6f6f6;
        }

        .home-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }

        .home-btn button {
            font-size: 20px;
            padding: 6px 12px;
            background-color: #ffffff;
            border: 2px solid #ccc;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            vertical-align: middle;
        }

        img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
        }

        .trash-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: red;
        }

        #total-price {
            text-align: right;
            margin-top: 15px;
            font-weight: bold;
        }

        #cart-container {
            max-width: 1000px;
            margin: auto;
        }

        .checkout-btn {
            text-align: right;
            margin-top: 10px;
        }

        .checkout-btn button {
            padding: 10px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        .checkout-btn button:hover {
            background-color: #388e3c;
        }
    </style>
</head>

<body>

    <!-- N√∫t Home -->
    <div class="home-btn">
        <button onclick="goHome()">üè†</button>
    </div>

    <div id="cart-container">
        <h3>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h3>
        <table>
            <thead>
                <tr>
                    <th>H√¨nh ·∫£nh</th>
                    <th>T√™n s·∫£n ph·∫©m</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>T·ªïng gi√°</th>
                    <th>X√≥a</th>
                </tr>
            </thead>
            <tbody id="cart-list">
            </tbody>
        </table>
        <p id="total-price"></p>
        <div class="checkout-btn">
            <button onclick="checkout()">üßæ Thanh to√°n</button>
        </div>
    </div>

    <script>
        let _id_user = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const _params = new URLSearchParams(window.location.search);
            _id_user = _params.get('msg');

            if (!_id_user || _id_user === "null") {
                alert("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi xem gi·ªè h√†ng.");
                window.location.href = "show_product.html";
                return;
            }

            await refreshCartList();
        });


        async function refreshCartList() {
            const cartList = document.getElementById('cart-list');
            const totalPriceElem = document.getElementById('total-price');

            try {
                const res = await fetch('http://localhost:18080/show_cart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id_user: _id_user })
                });

                const data = await res.json();
                const cartItems = data.products || [];
                const total = data.price || 0;

                cartList.innerHTML = '';

                if (cartItems.length === 0) {
                    cartList.innerHTML = `<tr><td colspan="5">Gi·ªè h√†ng tr·ªëng</td></tr>`;
                } else {
                    cartItems.forEach(product => {
                        const row = document.createElement('tr');
                        const imageUrl = product.image_url || 'https://via.placeholder.com/80x80?text=No+Image';
                        const price = parseFloat(product.price) || 0;
                        const quantity = parseInt(product.quantity) || 0;
                        const discount = parseFloat(product.discount) || 0;

                        const totalPrice = price * quantity * (100 - discount) / 100;

                        row.innerHTML = `
                            <td><img src="${imageUrl}" alt="·∫¢nh"></td>
                            <td>${product.name}</td>
                            <td>${product.quantity}</td>
                            <td>${totalPrice.toLocaleString("vi-VN", { style: "currency", currency: "VND" })}</td>
                            <td><button class="trash-btn" title="X√≥a" onclick='removeFromCart("${product.id || product.name}")'>üóëÔ∏è</button></td>
                        `;

                        cartList.appendChild(row);
                    });
                }

                totalPriceElem.textContent = `T·ªïng ti·ªÅn: ${parseFloat(total).toLocaleString("vi-VN", { style: "currency", currency: "VND" })}`;
            } catch (err) {
                console.error("L·ªói khi t·∫£i gi·ªè h√†ng:", err);
                cartList.innerHTML = `<tr><td colspan="5">L·ªói khi t·∫£i gi·ªè h√†ng</td></tr>`;
            }
        }

        function removeFromCart(productId) {
            fetch('http://localhost:18080/remove_product_from_cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id_user: _id_user,
                    id_product: productId,
                    quantity_change: "1"
                })
            })
                .then(res => res.json())
                .then(res => {
                    if (res.message === "Success") {
                        refreshCartList();
                    } else {
                        alert("Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m.");
                    }
                });
        }

        function checkout() {
            const today = new Date();
            const _date = {
                day: today.getDate(),
                month: today.getMonth() + 1,
                year: today.getFullYear()
            };
            console.log("üîç ƒêang g·ª≠i checkout v·ªõi:", _id_user, typeof _id_user);

            fetch('http://localhost:18080/checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id_user: _id_user,
                    date: _date
                })
            })
                .then(res => res.json())
                .then(res => {
                    if (res.message === "Success") {
                        alert("Thanh to√°n th√†nh c√¥ng.");
                        refreshCartList();
                    } else {
                        alert(res.message);
                    }
                })
                .catch(err => {
                    alert("L·ªói khi thanh to√°n.");
                    console.error(err);
                });
        }

        function goHome() {
            window.location.href = `show_product.html?msg=${encodeURIComponent(_id_user)}`;
        }
    </script>

</body>

</html>