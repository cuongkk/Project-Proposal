<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ƒêƒÉng nh·∫≠p</title>
    <style>
        .clickable {
            color: blue;
            cursor: pointer;
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div id="cart-container">
        <h3>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h3>
        <table>
            <thead>
                <tr>
                    <th>T√™n s·∫£n ph·∫©m</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>Gi√°</th>
                </tr>
            </thead>
            <tbody id="cart-list">
            </tbody>
        </table>
        <p id="total-price" style="text-align:right; margin-top: 10px;"></p>
        <div style="text-align:right;">
            <button onclick="checkout()">üßæ Thanh to√°n</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const _params = new URLSearchParams(window.location.search);
            const _id_user = _params.get('msg');

            if (!_id_user) {
                console.error("Kh√¥ng c√≥ 'msg' tr√™n URL");
                return;
            }

            await refreshCartList(_id_user);
        });

        async function refreshCartList(_id_user) {

            const cartList = document.getElementById('cart-list');
            const totalPriceElem = document.getElementById('total-price');

            fetch('http://localhost:18080/show_cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_user: _id_user })
            })
                .then(res => res.json())
                .then(data => {
                    const cartItems = data.products || [];
                    const total = data.price || 0;

                    cartList.innerHTML = '';

                    if (cartItems.length === 0) {
                        cartList.innerHTML = `<tr><td colspan="3">Gi·ªè h√†ng tr·ªëng</td></tr>`;
                        totalPriceElem.textContent = `T·ªïng ti·ªÅn: ${parseFloat(total).toLocaleString("vi-VN", { style: "currency", currency: "VND" })}`;

                        return;
                    }

                    totalPriceElem.textContent = `T·ªïng ti·ªÅn: ${parseFloat(total).toLocaleString("vi-VN", { style: "currency", currency: "VND" })}`;

                    cartItems.forEach(product => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                <td style="display:none;"><p>${product.id}</p></td>
                <td><p class="clickable">${product.name}</p></td>
                <td><p>${product.quantity}</p></td>
                <td><p>${parseFloat(product.price).toLocaleString("vi-VN", { style: "currency", currency: "VND" })}</p></td>
            `;
                        cartList.appendChild(row);

                        row.querySelector('.clickable').addEventListener('click', () => {
                            removeToCart(product);
                        });
                    });


                })
                .catch(err => {
                    console.error("L·ªói khi t·∫£i gi·ªè h√†ng:", err);
                    cartList.innerHTML = `<tr><td colspan="3">L·ªói khi t·∫£i gi·ªè h√†ng</td></tr>`;
                });
        }

        function removeToCart(product) {
            const _id_user = new URLSearchParams(window.location.search).get('msg');
            const productId = product.id || product.name;
            const quantityToRemove = "1";

            fetch('http://localhost:18080/remove_product_from_cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id_user: _id_user,
                    id_product: productId,
                    quantity_change: quantityToRemove
                })
            })
                .then(res => res.json())
                .then(res => {
                    if (res.message == "Success") {
                        refreshCartList(_id_user);
                    } else {
                        alert("Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m.");
                    }
                })
        }
        function checkout() {
            const _id_user = new URLSearchParams(window.location.search).get('msg');
            const today = new Date();
            const _date = {
                day: today.getDate(),
                month: today.getMonth() + 1,
                year: today.getFullYear()
            };
            fetch('http://localhost:18080/checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id_user: _id_user,
                    date: _date
                })
            })
                .then(res => res.json())
                .then(res => {
                    console.log(res);
                    if (res.message == "Success") {
                        alert("Thanh to√°n th√†nh c√¥ng.");
                        refreshCartList(_id_user);
                    }
                    else {
                        alert(res.message);
                    }
                })
                .catch(err => {
                    alert("L·ªói khi thanh to√°n.");
                    console.error(err);
                });
        }
    </script>

</body>

</html>